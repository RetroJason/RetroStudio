<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>BT Host (Simple)</title>
  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; background:#000; }
    #canvas { display:block; width:100%; height:100%; box-sizing:border-box; }
    #status { position:absolute; top:4px; left:8px; font:12px monospace; color:#9cf; background:rgba(0,0,0,.4); padding:2px 6px; border-radius:4px; pointer-events:none; }
  </style>
  <script>
    // Debug logging to understand the context
    console.log('[bt-host] Loading bt-host.html in context:', {
      isTopWindow: window.top === window.self,
      windowLocation: window.location.href,
      parentLocation: window.parent !== window ? window.parent.location.href : 'same as window',
      topLocation: window.top !== window ? window.top.location.href : 'same as window'
    });
    
    // Prevent navigation hijacking - ensure we're in an iframe context
    if (window.top === window.self) {
      // We're NOT in an iframe - this shouldn't happen
      console.error('[bt-host] Loaded in top window instead of iframe - blocking execution');
      document.body.innerHTML = '<div style="color:red;padding:20px;">BassoonTracker host should only run in iframe context</div>';
      throw new Error('bt-host must run in iframe');
    }
    
    // CRITICAL: Prevent BassoonTracker from hijacking browser navigation
    // Override window.location methods to block navigation attempts
    try {
      const originalLocation = window.location;
      Object.defineProperty(window, 'location', {
        get: function() { return originalLocation; },
        set: function(value) { 
          console.warn('[bt-host] Blocked navigation attempt to:', value);
          return false;
        },
        configurable: true
      });
    } catch (e) {
      console.warn('[bt-host] Could not override location (already defined):', e.message);
    }
    
    // Block direct location methods
    try {
      if (window.location.replace) {
        window.location.replace = function(url) {
          console.warn('[bt-host] Blocked location.replace to:', url);
        };
      }
      if (window.location.assign) {
        window.location.assign = function(url) {
          console.warn('[bt-host] Blocked location.assign to:', url);
        };
      }
    } catch (e) {
      console.warn('[bt-host] Could not override location methods:', e.message);
    }
    
    // Block document.location navigation
    try {
      Object.defineProperty(document, 'location', {
        get: function() { return window.location; },
        set: function(value) { 
          console.warn('[bt-host] Blocked document.location navigation to:', value);
          return false;
        },
        configurable: true
      });
    } catch (e) {
      console.warn('[bt-host] Could not override document.location:', e.message);
    }
    
    // Minimal host: notifications + project file load; saving handled via buildBinary in parent editor.
    window.HostBridge = { init(){}, signalReady(){}, useInitialLoad:false, useUrlParams:false, useWebWorkers:true, showInternalMenu:true, getBaseUrl(){return ''}, getRemoteUrl(){return ''} };
    try { if (new URLSearchParams(window.location.search).get('skipDemo') === '1') window.HostBridge.useInitialLoad = false; } catch(_){ }
    function setStatus(t){ try{ const el=document.getElementById('status'); if(!el) return; el.textContent=t; if(t && !/error|loading/i.test(t)){ setTimeout(()=>{ if(el.textContent===t) el.textContent=''; },2000);} }catch(_){}}
    function showCanvas(){ try{ const canvas=document.getElementById('canvas'); if(canvas) canvas.style.display='block'; }catch(_){} }
    function hideCanvas(){ try{ const canvas=document.getElementById('canvas'); if(canvas) canvas.style.display='none'; }catch(_){} }
    document.addEventListener('DOMContentLoaded', ()=>setStatus('booting...'));
    const BT_BASE='scripts/audio/external/BassoonTracker/';
    function wrapBtLoad(){ const BT=window.BassoonTracker; if(!BT||typeof BT.load!=='function'||BT.__notifyWrap) return; const orig=BT.load.bind(BT); BT.load=function(url,skipHistory,next,initial,silent){ try{ if(!window.__recentLoads) window.__recentLoads=new Map(); const now=performance.now(); for(const[k,v]of window.__recentLoads){ if(now-v>1000) window.__recentLoads.delete(k);} if(!window.__recentLoads.has(url)){ window.__recentLoads.set(url,now); parent.postMessage({type:'bt-load-invoked',url,skipHistory,initial,silent},'*'); } }catch(_){ } const userNext=next; const wrappedNext=()=>{ try{ parent.postMessage({type:'module-loaded',source:url||'unknown',via:'bt.load-callback'},'*'); }catch(_){ } if(typeof userNext==='function') try{ userNext(); }catch(e){ console.warn('[bt-host] user next callback error',e);} }; return orig(url,skipHistory,wrappedNext,initial,silent); }; if(typeof BT.loadModuleBuffer==='function'&&!BT.__loadModuleBufferWrap){ const ob=BT.loadModuleBuffer.bind(BT); BT.loadModuleBuffer=function(arrayBuffer,filename){ try{ parent.postMessage({type:'bt-load-invoked',url:`buffer://${filename}`,filename},'*'); }catch(_){ } const p=ob(arrayBuffer,filename); if(p&&typeof p.then==='function'){ p.then(s=>{ if(s) try{ parent.postMessage({type:'module-loaded',source:`buffer://${filename}`,via:'loadModuleBuffer'},'*'); }catch(_){ } }); } return p; }; BT.__loadModuleBufferWrap=true; } BT.__notifyWrap=true; }
    function wrapTrackerLoad(){ const TrackerRef=window.Tracker||(window.BassoonTracker&&window.BassoonTracker.Tracker)||(typeof Tracker!=='undefined'?Tracker:null); if(TrackerRef&&typeof TrackerRef.load==='function'&&!TrackerRef.__loadWrap){ const orig=TrackerRef.load; TrackerRef.load=function(url,skipHistory,next,initial,silent){ try{ if(!window.__recentLoads) window.__recentLoads=new Map(); const now=performance.now(); for(const[k,v]of window.__recentLoads){ if(now-v>1000) window.__recentLoads.delete(k);} if(!window.__recentLoads.has(url)){ window.__recentLoads.set(url,now); parent.postMessage({type:'bt-load-invoked',url,skipHistory,initial,silent,source:'tracker'},'*'); } }catch(_){ } const userNext=next; const wrappedNext=()=>{ try{ parent.postMessage({type:'module-loaded',source:url||'unknown',via:'tracker.load-callback'},'*'); }catch(_){ } if(typeof userNext==='function') try{ userNext(); }catch(e){ console.warn('[bt-host] tracker user next error',e);} }; return orig.call(this,url,skipHistory,wrappedNext,initial,silent); }; TrackerRef.__loadWrap=true; } if(!window.__xmlHttpHooked){ const o=XMLHttpRequest.prototype.open; XMLHttpRequest.prototype.open=function(m,u,...a){ if(u&&(u.includes('.mod')||u.includes('.xm')||u.includes('.s3m'))){ try{ parent.postMessage({type:'bt-load-invoked',url:u,source:'xhr'},'*'); }catch(_){ } } return o.call(this,m,u,...a); }; window.__xmlHttpHooked=true; } }
    (function schedule(){ wrapBtLoad(); wrapTrackerLoad(); requestAnimationFrame(schedule); })();
    (function(){ const q=[]; async function fetchRecord(path){ try{ const pw=parent; const fm=pw?.serviceContainer?.get?pw.serviceContainer.get('fileManager'):null; if(!fm) return null; let p=path; try{ const proj=pw.gameEditor?.projectExplorer?.getFocusedProjectName?.(); if(proj&&p.startsWith(proj+'/')) p=p.substring(proj.length+1);}catch(_){ } return await fm.loadFile(p);}catch(e){ return null;} } async function recToUrl(rec){ if(!rec) return null; let c=rec.content||rec.fileContent; if(typeof c==='string'){ try{ const bin=atob(c); const arr=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i); c=arr.buffer;}catch(_){ return null;} } if(c instanceof ArrayBuffer){ const blob=new Blob([c],{type:'application/octet-stream'}); return URL.createObjectURL(blob)+'#'+encodeURIComponent(rec.filename||'module.mod'); } return null;} async function process(){ if(!window.BassoonTracker||typeof window.BassoonTracker.load!=='function') return; while(q.length){ const job=q.shift(); try{ const rec=job.rec||await fetchRecord(job.path); let usedRaw=false; try{ const content=rec?.content||rec?.fileContent; if(content&&window.BassoonTracker.loadModuleBuffer){ let buf=content; if(typeof buf==='string'){ const bin=atob(buf); const arr=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i); buf=arr.buffer;}             if(buf instanceof ArrayBuffer&&buf.byteLength>0){ if(window.BassoonTracker.disableInitialDemo) window.BassoonTracker.disableInitialDemo(); setStatus('loading module (raw)'); showCanvas(); await window.BassoonTracker.loadModuleBuffer(buf,rec?.filename||'module.mod'); usedRaw=true; } } }catch(_){ } if(!usedRaw){ const url=await recToUrl(rec);           if(url){ if(window.BassoonTracker.disableInitialDemo) window.BassoonTracker.disableInitialDemo(); setStatus('loading project file'); showCanvas(); window.BassoonTracker.load(url); } } }catch(_){ } } } window.loadProjectFile=function(path){ q.push({path}); process(); }; window.loadProjectFileRecord=function(rec){ if(rec&&rec.filename) q.push({path:rec.path||rec.filename,rec}); process(); }; setInterval(process,250); })();
    window.addEventListener('message', e=>{ const msg=e.data||{}; if(!msg.type) return; if(msg.type==='ping'){ try{ parent.postMessage({type:'bt-ready'},'*'); }catch(_){ } return; } if(msg.type==='load-file-from-service'&&msg.filePath){ window.HostBridge.useInitialLoad=false; const run=async()=>{ const BT=window.BassoonTracker; if(!BT||typeof BT.loadFromFileService!=='function'){ return; } try{ setStatus('loading from file service'); const result=await BT.loadFromFileService(msg.filePath,msg.filename); if(result) try{ parent.postMessage({type:'module-loaded',source:msg.filePath||msg.filename||'service-file',via:'file-service-promise'},'*'); }catch(_){ } setStatus(''); try{ parent.postMessage({type:'file-load-result',success:result,filePath:msg.filePath},'*'); }catch(_){ } }catch(err){ setStatus(''); try{ parent.postMessage({type:'file-load-result',success:false,error:err.message,filePath:msg.filePath},'*'); }catch(_){ } } }; run(); return; } const run=()=>{ const BT=window.BassoonTracker; if(!BT||typeof BT.load!=='function') return; if(msg.type==='load-bytes'&&msg.bytes){ try{ const blob=new Blob([new Uint8Array(msg.bytes)],{type:'application/octet-stream'}); const url=URL.createObjectURL(blob)+(msg.name?('#'+encodeURIComponent(msg.name)):'' ); setStatus('loading file'); BT.load(url); }catch(_){ } }         else if(msg.type==='load-demo'){ setStatus('loading demo'); showCanvas(); BT.load(BT_BASE+'demomods/Tinytune.mod'); setTimeout(()=>setStatus(''),2000);} }; run(); });
  </script>
  <script type="module" src="scripts/audio/external/BassoonTracker/build/main-Bv1ehicc.js"></script>
</head>
<body>
  <div id="status">loading…</div>
  <canvas id="canvas" tabindex="1"></canvas>
</body>
</html>
